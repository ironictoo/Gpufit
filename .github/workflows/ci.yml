name: Build

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev
  workflow_dispatch:

jobs:
  build:
    name: ${{ matrix.os }} ${{ matrix.arch }} cuda-${{ matrix.cuda }} python-${{ matrix.python }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows: old/new supported runner + old/new CUDA
          - os: windows-2022
            arch: x64
            with_cuda: true
            cuda: "12.4.1"
            visual_studio: "Visual Studio 17 2022"
            vc_toolset: "v170"
            python: "3.10"

          - os: windows-2025
            arch: x64
            with_cuda: true
            cuda: "12.8.1"
            visual_studio: "Visual Studio 17 2022"
            vc_toolset: "v170"
            python: "3.12"

          # Linux: old/new supported runner + old/new CUDA
          - os: ubuntu-22.04
            arch: x64
            with_cuda: true
            cuda: "11.8.0"
            python: "3.10"

          - os: ubuntu-24.04
            arch: x64
            with_cuda: true
            cuda: "12.8.1"
            python: "3.12"

          # macOS: Intel + Apple Silicon CPU-only validation
          - os: macos-15-intel
            arch: x64
            with_cuda: false
            cuda: "cpu"
            python: "3.10"

          - os: macos-14
            arch: arm64
            with_cuda: false
            cuda: "cpu"
            python: "3.12"

    env:
      build_dir: "build"
      config: "Release"
      gpufit_version: "1.2.0"
      vcpkg_triplet: "x64-windows"

    steps:
      - uses: actions/checkout@v6

      - name: Setup Python ${{ matrix.python }}
        uses: actions/setup-python@v6
        with:
          python-version: "${{ matrix.python }}"
          cache: "pip"

      - name: Upgrade Pip and Install wheel
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools numpy

      - name: Setup MATLAB
        uses: matlab-actions/setup-matlab@v2.6.1

      - name: Setup Java
        if: runner.os != 'Windows' && matrix.with_cuda
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "8"

      - name: Install Boost (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $vcpkg = Join-Path $env:VCPKG_INSTALLATION_ROOT "vcpkg.exe"
          & $vcpkg install boost-test:${{ env.vcpkg_triplet }}

      - name: Install Boost (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libboost-dev

      - name: Install Boost (macOS)
        if: runner.os == 'macOS'
        run: |
          if ! brew list --versions boost >/dev/null 2>&1; then
            brew install boost
          fi

      - name: Install CUDA (Windows)
        if: runner.os == 'Windows' && matrix.with_cuda
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit-w
        with:
          sub-packages: '["nvcc", "visual_studio_integration", "cublas", "curand", "nvrtc", "cudart"]'
          cuda: ${{ matrix.cuda }}
          method: network

      - name: Export CUDA path from installer (Windows)
        if: runner.os == 'Windows' && matrix.with_cuda
        shell: bash
        run: |
          echo "CUDA_PATH=${{ steps.cuda-toolkit-w.outputs.CUDA_PATH }}" >> "$GITHUB_ENV"
          echo "${{ steps.cuda-toolkit-w.outputs.CUDA_PATH }}/bin" >> "$GITHUB_PATH"

      - name: Install CUDA (Linux)
        if: runner.os == 'Linux' && matrix.with_cuda
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit-l
        with:
          sub-packages: '["nvcc", "nvrtc", "cudart"]'
          cuda: ${{ matrix.cuda }}
          method: network

      - name: Enable CUDA BuildCustomizations (Windows)
        if: runner.os == 'Windows' && matrix.with_cuda
        shell: bash
        run: |
          VSWHERE="/c/Program Files (x86)/Microsoft Visual Studio/Installer/vswhere.exe"
          VS_PATH=$("$VSWHERE" -latest -products '*' -property installationPath | tr -d '\r')
          echo "Visual Studio path: $VS_PATH"
          cp -R "$CUDA_PATH/extras/visual_studio_integration/MSBuildExtensions/." "$VS_PATH/MSBuild/Microsoft/VC/${{ matrix.vc_toolset }}/BuildCustomizations"

      - name: nvcc check
        if: matrix.with_cuda
        shell: bash
        run: |
          nvcc -V
          ls "$CUDA_PATH"
          ls "$CUDA_PATH/bin"
          ls "$CUDA_PATH/include"

      - name: cmake version
        shell: bash
        run: cmake --version

      - name: Configure CMake (Windows)
        id: configure-w
        shell: bash
        if: runner.os == 'Windows'
        run: |
          rm -f "${{ env.build_dir }}/CMakeCache.txt"
          cmake . -B "${{ env.build_dir }}" -G "${{ matrix.visual_studio }}" -A x64 -DCMAKE_GENERATOR_TOOLSET="cuda=$CUDA_PATH" -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=${{ env.vcpkg_triplet }} -DBUILD_TESTING=ON -DCMAKE_DISABLE_FIND_PACKAGE_Java=TRUE -DCMAKE_DISABLE_FIND_PACKAGE_JNI=TRUE

      - name: Configure CMake (Linux)
        id: configure-l
        shell: bash
        if: runner.os == 'Linux'
        run: |
          rm -f "${{ env.build_dir }}/CMakeCache.txt"
          cmake . -B "${{ env.build_dir }}" -DCMAKE_BUILD_TYPE=RELEASE -DBUILD_TESTING=ON

      - name: Configure CMake (macOS CPU-only)
        id: configure-m
        shell: bash
        if: runner.os == 'macOS'
        run: |
          rm -f "${{ env.build_dir }}/CMakeCache.txt"
          cmake . -B "${{ env.build_dir }}" -DCMAKE_BUILD_TYPE=RELEASE -DGPUFIT_ENABLE_CUDA=OFF -DBUILD_TESTING=ON

      - name: Configure Error Processing
        if: always()
        shell: bash
        run: |
          if [[ ! -d "${{ env.build_dir }}" ]]; then
            echo "Build directory '${{ env.build_dir }}' not created; skipping CMake log dump."
            exit 0
          fi
          cd "${{ env.build_dir }}"
          if [[ -f "CMakeFiles/CMakeOutput.log" ]]; then
            echo "---- CMakeFiles/CMakeOutput.log"
            cat CMakeFiles/CMakeOutput.log
            echo "----"
          fi
          if [[ -f "CMakeFiles/CMakeError.log" ]]; then
            echo "---- CMakeFiles/CMakeError.log"
            cat CMakeFiles/CMakeError.log
            echo "----"
          fi

      - name: Build (Windows)
        if: runner.os == 'Windows'
        working-directory: ${{ env.build_dir }}
        run: cmake --build . --config ${{ env.config }} --target ALL_BUILD --verbose

      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        working-directory: ${{ env.build_dir }}
        run: cmake --build . --verbose

      - name: Verify pyCpufit import
        shell: bash
        run: |
          set -euo pipefail
          cpufit_pkg_root="$(find "${{ env.build_dir }}" -type d -name pyCpufit | head -n 1 || true)"
          if [[ -z "${cpufit_pkg_root}" ]]; then
            echo "pyCpufit package root not found under ${{ env.build_dir }}."
            find "${{ env.build_dir }}" -maxdepth 5 -type d -print
            exit 1
          fi
          export PYTHONPATH="${cpufit_pkg_root}${PYTHONPATH:+:${PYTHONPATH}}"
          python - <<'PY'
          import pycpufit.cpufit as cf
          print("pycpufit:", cf.__file__)
          print("fit_constrained:", hasattr(cf, "fit_constrained"))
          PY

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        run: ctest --test-dir "${{ env.build_dir }}" -C "${{ env.config }}" --output-on-failure

      - name: Run tests (Linux/macOS)
        if: runner.os != 'Windows'
        run: ctest --test-dir "${{ env.build_dir }}" --output-on-failure

      - name: Upload Artifacts (Windows)
        uses: actions/upload-artifact@v6
        if: runner.os == 'Windows'
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}-cuda-${{ matrix.cuda }}
          path: build/Release/**/*

      - name: Upload Artifacts (Linux/macOS)
        uses: actions/upload-artifact@v6
        if: runner.os != 'Windows'
        with:
          name: ${{ matrix.os }}-${{ matrix.arch }}-cuda-${{ matrix.cuda }}
          path: build/**/*
